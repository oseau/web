#!/usr/bin/env bash

# Function to handle graceful shutdown
cleanup() {
    echo "Received shutdown signal, cleaning up..."
    # Kill any running Go processes
    pkill -f "go run" || true
    exit 0
}

# Trap SIGTERM and SIGINT
trap cleanup SIGTERM SIGINT

while sleep 0.1
do
{
    # escape "$" here so the timestamp will be evaluated when the command is executed
    find /usr/src/app -name '*.go' -o -name 'go.mod' | entr -cdnrs \
        "echo ================ start dev @ \$(TZ=Asia/Shanghai date) ================ \
        && staticcheck ./... \
        && go vet ./... \
        && revive ./... \
        && go run -ldflags \"\$LDFLAGS\" /usr/src/app/cmd/backend/*.go" &

    # Wait for the background process
    wait $!
}
done
